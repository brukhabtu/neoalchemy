# Source Tracking in NeoAlchemy

NeoAlchemy includes built-in source tracking functionality that allows you to track the provenance of data in your graph database. This document explains the source tracking system and how to use it.

## Overview

The source tracking system in NeoAlchemy consists of:

1. **Source URIs**: Simple strings in the format `scheme:identifier` that can be attached to any Node or Relationship
2. **Source Nodes**: Neo4j nodes representing data sources with rich metadata
3. **SOURCED_FROM Relationships**: Relationships connecting entities to their sources

This combination provides both simplicity for validation and power for querying.

## Key Components

### 1. Source URI Format

Source URIs follow the format `scheme:identifier`, where:
- `scheme` is a category like "jira", "confluence", "llm", etc.
- `identifier` is a unique identifier within that scheme

Examples:
- `jira:PROJ-123` - A JIRA issue
- `confluence:space/page` - A Confluence page
- `llm:claude-3` - Content generated by an LLM
- `user:john.doe@example.com` - Information from a user

### 2. Source Node Model

```python
class Source(Node):
    """Node representing a data source in Neo4j."""
    id: UUID = Field(default_factory=uuid4)
    uri: str = UniqueField(description="URI identifier (e.g., 'jira:ABC-123')")
    scheme: SourceScheme = IndexedField(description="Source type (e.g., 'jira', 'llm')")
    identifier: str = IndexedField(description="Source identifier part of the URI")
    name: str = Field(description="Display name for the source")
    description: Optional[str] = Field(default=None)
    url: Optional[str] = Field(default=None)
    timestamp: DateTime = Field(default_factory=lambda: DateTime.from_native(datetime.now()))
```

### 3. SOURCED_FROM Relationship

```python
class SOURCED_FROM(Relationship):
    """Relationship connecting an entity to its source."""
    timestamp: DateTime = Field(default_factory=lambda: DateTime.from_native(datetime.now()))
    context: Optional[str] = Field(default=None, description="Additional context about the source relationship")
```

## Usage

### 1. Creating Entities with Sources

All `Node` and `Relationship` models in NeoAlchemy have a built-in `sources` field that can hold a list of source URIs:

```python
# Create a person with sources
john = Person(
    name="John Doe",
    email="john.doe@example.com",
    age=35,
    sources=["jira:HR-123", "llm:claude-3"]  # Source URIs
)

# Create the person in the database
with repo.transaction() as tx:
    created_john = tx.create(john)  # Sources created automatically
```

When you create an entity with source URIs, NeoAlchemy will:
1. Create the entity itself
2. Create Source nodes for each URI (if they don't already exist)
3. Create SOURCED_FROM relationships connecting the entity to its sources

### 2. Adding Sources to Existing Entities

You can add sources to existing entities:

```python
# Add a source to an existing entity
with repo.transaction() as tx:
    tx.relate_to_source(
        entity=john,
        uri="slack:general-channel",
        context="Mentioned in Slack chat"
    )
```

### 3. Finding Entities by Source

```python
# Find all entities sourced from a specific URI
with repo.transaction() as tx:
    jira_entities = tx.find_by_source(Person, "jira:HR-123")
    
    # Find all entities from a specific source type
    llm_entities = tx.find_by_source_scheme(Person, "llm")
```

### 4. Getting Sources for an Entity

```python
# Get all sources for an entity
with repo.transaction() as tx:
    sources = tx.get_sources(john)
    for source in sources:
        print(f"{source.name} ({source.uri})")
```

### 5. Creating Sources Directly

```python
# Create a source directly
with repo.transaction() as tx:
    source = Source.from_uri(
        "jira:PROJ-123",
        name="Project Planning",
        description="Project planning document",
        url="https://jira.example.com/browse/PROJ-123"
    )
    created_source = tx.create(source)
    
    # Connect entity to source
    tx.relate(
        john,
        SOURCED_FROM(context="Assigned to task"),
        created_source
    )
```

## Best Practices

1. **Always Include Sources**: Include at least one source URI for every entity to track data provenance.

2. **Use Consistent Schemes**: Establish naming conventions for source schemes (e.g., "jira", "confluence", "llm").

3. **Leverage URI Format**: The `scheme:identifier` format makes it easy to validate and query sources.

4. **Add Context**: Use the `context` field in SOURCED_FROM relationships to provide additional information.

5. **Rich Queries**: Use the source tracking system for advanced queries like:
   - Finding all entities from a specific source
   - Identifying entities with a particular source type
   - Determining the primary sources of information

## Example

A complete example:

```python
from uuid import uuid4
from neo4j import GraphDatabase
from neoalchemy import (
    Node, Relationship, Neo4jRepository, 
    initialize, Source, SOURCED_FROM
)

# Define models
class Person(Node):
    name: str
    email: str
    age: int = None

# Initialize and connect
initialize()
driver = GraphDatabase.driver("bolt://localhost:7687", auth=("neo4j", "password"))
repo = Neo4jRepository(driver)

# Use a transaction
with repo.transaction() as tx:
    # Create with sources
    alice = Person(
        name="Alice Smith",
        email=f"alice.{uuid4().hex[:8]}@example.com",
        age=30,
        sources=["jira:HR-456", "linkedin:alice-smith"]
    )
    created_alice = tx.create(alice)
    
    # Add another source
    tx.relate_to_source(
        created_alice,
        "email:hr@example.com",
        context="Onboarding email"
    )
    
    # Find by source
    hr_people = tx.find_by_source(Person, "jira:HR-456")
    print(f"Found {len(hr_people)} people from HR-456")
    
    # Get sources
    alice_sources = tx.get_sources(created_alice)
    print(f"Alice has {len(alice_sources)} sources:")
    for source in alice_sources:
        print(f"  - {source.name} ({source.uri})")

driver.close()
```

## Migration from Custom Source Tracking

If you previously implemented your own source tracking system:

1. Use the built-in `sources` field on Node and Relationship models
2. Use the built-in transaction methods: `relate_to_source`, `find_by_source`, etc.
3. Take advantage of the source validation and automatic relationship creation

The built-in system integrates deeply with NeoAlchemy's ORM, making source tracking more seamless and powerful.